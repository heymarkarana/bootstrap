#!/usr/bin/env bash

BIN_NAME=$(basename "$0")
COMMAND=$1 # Command entered - install or refresh
BRANCH=$2  # The branch name or commit reference can be passed as the second argument
PROJECT="dotFiles"
REPO1="git@git.kuzcotopia.io:marana/${PROJECT}.git"
REPO1_NAME="Kuzcotopia"
REPO2="git@github.com:heymarkarana/${PROJECT}.git"
REPO2_NAME="GitHub"
DEFAULT_REPO="${REPO1}" # Default repository
SELECTED_REPO="${DEFAULT_REPO}"
TARGET="${HOME}/.dotFiles"

# Function to show help information
show_help() {
  echo
  echo "Usage: ${BIN_NAME} <command> [branch|tag] [options]"
  echo
  echo "Commands:"
  echo "   install                    Set up .dotFiles from scratch. Installs ZSH and Homebrew if required."
  echo "   install [branch|tag]       Specify a branch or tag to install. Defaults to 'main'."
  echo
  echo "   refresh                    Refresh the existing .dotFiles repository. Defaults to pulling the 'main' branch."
  echo "   refresh <branch|tag>       Refresh and pull a specific branch or tag."
  echo "   refresh --hard <branch|tag> Hard reset to a specific branch or tag. Deletes and reclones the .dotFiles repository."
  echo
  echo "Options:"
  echo "   --repo <repository>        Specify the repository to clone from. Defaults to:"
  echo "                               - ${REPO1_NAME}: ${REPO1}"
  echo "                               - ${REPO2_NAME}: ${REPO2}"
  echo
  echo "Examples:"
  echo
  echo "   Install Examples:"
  echo "     1. Install from the default (main) branch:"
  echo "        ./$(basename "$0") install"
  echo
  echo "     2. Install from a specific branch:"
  echo "        ./$(basename "$0") install develop"
  echo
  echo "     3. Install from a specific tag:"
  echo "        ./$(basename "$0") install v2.1.2"
  echo
  echo "     4. Install from a specific repository:"
  echo "        ./$(basename "$0") install --repo git@github.com:heymarkarana/dotFiles.git"
  echo
  echo "   Refresh Examples:"
  echo "     1. Refresh the current branch (default: main):"
  echo "        ./$(basename "$0") refresh"
  echo
  echo "     2. Refresh a specific branch:"
  echo "        ./$(basename "$0") refresh feature/my-update"
  echo
  echo "     3. Refresh to a specific tag:"
  echo "        ./$(basename "$0") refresh v2.1.2"
  echo
  echo "     4. Perform a hard reset to the main branch:"
  echo "        ./$(basename "$0") refresh --hard main"
  echo
  echo "     5. Perform a hard reset to a specific tag:"
  echo "        ./$(basename "$0") refresh --hard v2.1.2"
  echo
  echo "   Using Custom Repository:"
  echo "     1. Install from a custom repository:"
  echo "        ./$(basename "$0") install --repo git@github.com:heymarkarana/dotFiles.git"
  echo
  echo "     2. Refresh a specific branch from a custom repository:"
  echo "        ./$(basename "$0") refresh feature/experimental --repo git@github.com:heymarkarana/dotFiles.git"
  echo
  echo "     3. Perform a hard reset to a tag from a custom repository:"
  echo "        ./$(basename "$0") refresh --hard v2.1.2 --repo git@github.com:heymarkarana/dotFiles.git"
  echo
  echo "Notes:"
  echo "   - Tags are immutable snapshots. If you check out a tag, a new branch will be created for further changes."
  echo "   - If '--repo' is not specified, the default repository (${DEFAULT_REPO}) will be used."
  echo
}
# Parse additional arguments
parse_arguments() {
  while [[ $# -gt 0 ]]; do
    case $1 in
      --repo)
        SELECTED_REPO=$2
        shift # Consume argument value
        ;;
      *)
        ;;
    esac
    shift
  done
}

# Function to switch shell
switch_to_zsh() {
  local current_shell
  current_shell=$(getent passwd "$USER" | cut -d: -f7)
  local zsh_path
  zsh_path=$(command -v zsh)

  if [[ "${current_shell}" != "${zsh_path}" ]]; then
    echo "Changing default shell to ZSH..."
    if chsh -s "${zsh_path}"; then
      echo "Default shell changed to ZSH."
      echo "Please log out and back in for the change to take effect."
      echo "Or run 'zsh' manually to switch to ZSH for this session."

      read -r -p "Would you like to switch to ZSH for this session? [y/N] " response
      if [[ "${response}" =~ ^[Yy]$ ]]; then
        exec "${zsh_path}" -l
      fi
    else
      echo "Failed to change default shell. You can manually run: chsh -s $(command -v zsh)"
    fi
  else
    echo "ZSH is already your default shell."
  fi
}

# Function to install Homebrew on macOS
install_homebrew() {
  if [[ "$(uname)" == "Darwin" ]]; then
    if ! command -v brew &>/dev/null; then
      echo "Installing Homebrew..."
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      if ! grep -q "eval \"\$(/opt/homebrew/bin/brew shellenv)\"" "${HOME}/.zshrc"; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> "${HOME}/.zshrc"
      fi

      eval "$(/opt/homebrew/bin/brew shellenv)"
      echo "Homebrew installation complete."
    else
      echo "Homebrew is already installed."
    fi
  else
    echo "Skipping Homebrew installation: not on macOS."
  fi
}

# Function to install ZSH
install_zsh() {
  if command -v zsh &>/dev/null; then
    touch "${HOME}/.zshrc"
    echo "ZSH is already installed."
  else
    echo "Installing ZSH..."
    sudo apt update -q && sudo apt install -y zsh
    touch "${HOME}/.zshrc"
    echo "ZSH installation complete."
  fi
}

# Function to set up dotFiles
install_dotfiles() {
  echo "Setting up .dotFiles..."
  install_homebrew
  install_zsh

  # Branch or tag to use (default: main)
  local branch_or_tag="${BRANCH:-main}"

  echo "Cloning dotFiles from ${SELECTED_REPO}..."
  if git clone "${SELECTED_REPO}" "${TARGET}"; then
    cd "${TARGET}" || exit 1
    # Checkout branch or tag
    if git rev-parse --verify "refs/tags/${branch_or_tag}" >/dev/null 2>&1; then
      echo "Checking out tag ${branch_or_tag}..."
      git checkout "tags/${branch_or_tag}" -b "${branch_or_tag}-branch"
    else
      echo "Checking out branch ${branch_or_tag}..."
      git checkout "${branch_or_tag}"
    fi
    echo "dotFiles setup complete."
    switch_to_zsh
  else
    echo "Git clone failed. Exiting."
    exit 1
  fi
}

# Function to refresh dotFiles
refresh_dotfiles() {
  echo "Refreshing .dotFiles..."
  local branch_or_tag="${1:-main}"

  if [[ "${branch_or_tag}" == "--hard" ]]; then
    branch_or_tag="${2:-main}"
    echo "Performing a hard reset to ${branch_or_tag}..."
    rm -rf "${TARGET}"
    git clone "${SELECTED_REPO}" "${TARGET}" || {
      echo "Failed to clone repository. Exiting."
      exit 1
    }
    cd "${TARGET}" || exit 1
    if git rev-parse --verify "refs/tags/${branch_or_tag}" >/dev/null 2>&1; then
      echo "Checking out tag ${branch_or_tag}..."
      git checkout "tags/${branch_or_tag}" -b "${branch_or_tag}-branch"
    else
      echo "Checking out branch ${branch_or_tag}..."
      git checkout "${branch_or_tag}"
    fi
  else
    cd "${TARGET}" || exit 1
    if git rev-parse --verify "refs/tags/${branch_or_tag}" >/dev/null 2>&1; then
      echo "Fetching and checking out tag ${branch_or_tag}..."
      git fetch --tags
      git checkout "tags/${branch_or_tag}" -b "${branch_or_tag}-branch"
    else
      echo "Pulling latest updates from branch ${branch_or_tag}..."
      git pull origin "${branch_or_tag}" || {
        echo "Failed to pull updates. Exiting."
        exit 1
      }
    fi
  fi
}

# Main script logic
parse_arguments "$@"
case ${COMMAND} in
  "" | "-h" | "--help")
    show_help
    ;;
  install)
    # Ensure the bootstrap script exists and is executable
    if [[ -x "${HOME}/.bootstrap/GitHarness.sh" ]]; then
      "${HOME}/.bootstrap/GitHarness.sh"
    fi
    install_dotfiles

    ;;
  refresh)
    refresh_dotfiles "$2"
    ;;
  *)
    echo "Unknown command: ${COMMAND}" >&2
    show_help
    exit 1
    ;;
esac