#!/usr/bin/env bash

############################################################################################################
#
# Start dotFiles initialization
#
############################################################################################################

# This will setup a env file that has the default install directory for dotFiles. Change this manually if you want to install someplace else.
# DOT_FILES_APP_INSTALL_DIRECTORY="/opt/kuzcotopia"
# DOT_FILES_ENV_FILE_LOCATION  <-- must not change. There are other templates hardcoded to this location

DOT_FILES_INSTALL_FOLDER_NAME=".dotFiles"
DOT_FILES_ENV_FILE="df.env"
DOT_FILES_ENV_FILE_LOCATION="${HOME}/.config/dotFiles/${DOT_FILES_ENV_FILE}"
DOT_FILES_INSTALL_DIRECTORY="${HOME}/${DOT_FILES_INSTALL_FOLDER_NAME}"
DOT_FILES_APP_INSTALL_DIRECTORY="/opt/kuzcotopia"
DOT_FILES_LOG_LEVEL="WARN"
DOT_FILES_STDOUT_DISPLAY="false"
DOT_FILES_GROUP_NAME="kgroup"
DOT_FILES_DEFAULT_DOMAIN="kuzcotopia.io"

# Function to detect platform
detect_platform() {
    local platform=""

    if [[ "$OSTYPE" == "darwin"* ]]; then
        platform="macOS"
    elif [[ -f "/etc/lsb-release" ]] && grep -q "Ubuntu" "/etc/lsb-release"; then
        platform="ubuntu"
    else
        echo "Error: Unsupported platform. Only macOS and ubuntu are supported."
        exit 1
    fi

    echo "$platform"
}

# Get the platform
DOT_FILES_PLATFORM=$(detect_platform)

# Default variables
declare -a VAR_NAMES=(
    "DOT_FILES_INSTALL_DIRECTORY"
    "DOT_FILES_APP_INSTALL_DIRECTORY"
    "DOT_FILES_PLATFORM"
    "DOT_FILES_LOG_LEVEL"
    "DOT_FILES_STDOUT_DISPLAY"
    "DOT_FILES_GROUP_NAME"
    "DOT_FILES_DEFAULT_DOMAIN"
)

declare -a VAR_VALUES=(
    "${DOT_FILES_INSTALL_DIRECTORY}"
    "${DOT_FILES_APP_INSTALL_DIRECTORY}"
    "${DOT_FILES_PLATFORM}"
    "${DOT_FILES_LOG_LEVEL}"
    "${DOT_FILES_STDOUT_DISPLAY}"
    "${DOT_FILES_GROUP_NAME}"
    "${DOT_FILES_DEFAULT_DOMAIN}"
)
# Function to write a variable to the env file
write_variable_to_env() {
    local var_name="$1"
    local var_value="$2"

    # Append the variable if it's missing
    if ! grep -q "^${var_name}=" "${DOT_FILES_ENV_FILE_LOCATION}" 2>/dev/null; then
        echo "${var_name}=\"${var_value}\"" | tee -a "${DOT_FILES_ENV_FILE_LOCATION}" >/dev/null
        echo "Added missing variable: ${var_name}=\"${var_value}\""
    fi
}

# Ensure the environment file exists
initialize_env_file() {
    if [[ ! -f "${DOT_FILES_ENV_FILE_LOCATION}" ]]; then
        mkdir -p "$(dirname "${DOT_FILES_ENV_FILE_LOCATION}")"
        touch "${DOT_FILES_ENV_FILE_LOCATION}"
        chmod a+rx "${DOT_FILES_ENV_FILE_LOCATION}"
        echo "Created environment file at ${DOT_FILES_ENV_FILE_LOCATION}"
    fi
}

# Ensure all default variables are present in the env file
ensure_variables_in_env() {
    local i
    for i in "${!VAR_NAMES[@]}"; do
        write_variable_to_env "${VAR_NAMES[$i]}" "${VAR_VALUES[$i]}"
    done
}

get_target_directory() {
    if [[ -f "${DOT_FILES_ENV_FILE_LOCATION}" ]]; then
        # shellcheck disable=SC1090
        source "${DOT_FILES_ENV_FILE_LOCATION}" 2>/dev/null
        echo "${DOT_FILES_INSTALL_DIRECTORY}"
    else
        echo "${HOME}/.dotFiles"
    fi
}

# Main logic
initialize_env_file
ensure_variables_in_env

# Define other variables necessary for this script
BIN_NAME=$(basename "$0")
COMMAND=$1 # Command entered - install or refresh
BRANCH=$2  # The branch name or commit reference can be passed as the second argument
PROJECT="dotFiles"
REPO1="git@git.kuzcotopia.io:marana/${PROJECT}.git"
REPO1_NAME="Kuzcotopia"
REPO2="git@github.com:heymarkarana/${PROJECT}.git"
REPO2_NAME="GitHub"
DEFAULT_REPO="${REPO1}" # Default repository
SELECTED_REPO="${DEFAULT_REPO}"
#TARGET=$(source "${DOT_FILES_ENV_FILE_LOCATION}" 2>/dev/null && echo "${DOT_FILES_INSTALL_DIRECTORY}" || echo "${HOME}/.dotFiles")
TARGET=$(get_target_directory)


############################################################################################################
#
# End initialization
#
############################################################################################################


# Function to show help information
show_help() {
  echo
  echo "Usage: ${BIN_NAME} <command> [branch|tag] [options]"
  echo
  echo "Commands:"
  echo "   init                       Display the initialization status. Outputs the environment variables defined in the environment file."
  echo
  echo "   install                    Set up .dotFiles from scratch. Installs ZSH and Homebrew if required."
  echo "   install [branch|tag]       Specify a branch or tag to install. Defaults to 'main'."
  echo
  echo "   refresh                    Refresh the existing .dotFiles repository. Defaults to pulling the 'main' branch."
  echo "   refresh <branch|tag>       Refresh and pull a specific branch or tag."
  echo "   refresh --hard <branch|tag> Hard reset to a specific branch or tag. Deletes and reclones the .dotFiles repository."
  echo
  echo "Options:"
  echo "   --repo <repository>        Specify the repository to clone from. Defaults to:"
  echo "                               - ${REPO1_NAME}: ${REPO1}"
  echo "                               - ${REPO2_NAME}: ${REPO2}"
  echo
  echo "Examples:"
  echo
  echo "   Init Example:"
  echo "     1. Display environment variables:"
  echo "        ./$(basename "$0") init"
  echo
  echo "   Install Examples:"
  echo "     1. Install from the default (main) branch:"
  echo "        ./$(basename "$0") install"
  echo
  echo "     2. Install from a specific branch:"
  echo "        ./$(basename "$0") install develop"
  echo
  echo "     3. Install from a specific tag:"
  echo "        ./$(basename "$0") install v2.1.2"
  echo
  echo "     4. Install from a specific repository:"
  echo "        ./$(basename "$0") install --repo git@github.com:heymarkarana/dotFiles.git"
  echo
  echo "   Refresh Examples:"
  echo "     1. Refresh the current branch (default: main):"
  echo "        ./$(basename "$0") refresh"
  echo
  echo "     2. Refresh a specific branch:"
  echo "        ./$(basename "$0") refresh feature/my-update"
  echo
  echo "     3. Refresh to a specific tag:"
  echo "        ./$(basename "$0") refresh v2.1.2"
  echo
  echo "     4. Perform a hard reset to the main branch:"
  echo "        ./$(basename "$0") refresh --hard main"
  echo
  echo "     5. Perform a hard reset to a specific tag:"
  echo "        ./$(basename "$0") refresh --hard v2.1.2"
  echo
  echo "   Using Custom Repository:"
  echo "     1. Install from a custom repository:"
  echo "        ./$(basename "$0") install --repo git@github.com:heymarkarana/dotFiles.git"
  echo
  echo "     2. Refresh a specific branch from a custom repository:"
  echo "        ./$(basename "$0") refresh feature/experimental --repo git@github.com:heymarkarana/dotFiles.git"
  echo
  echo "     3. Perform a hard reset to a tag from a custom repository:"
  echo "        ./$(basename "$0") refresh --hard v2.1.2 --repo git@github.com:heymarkarana/dotFiles.git"
  echo
  echo "Notes:"
  echo "   - Tags are immutable snapshots. If you check out a tag, a new branch will be created for further changes."
  echo "   - If '--repo' is not specified, the default repository (${DEFAULT_REPO}) will be used."
  echo
}

introduction() {

  echo
  echo
  echo " ________________________________________"
  echo "/ Chuck Norris does not use spell check. \\"
  echo "| If he happens to misspell a word,      |"
  echo "\\ Oxford will change the spelling        /"
  echo " ----------------------------------------"
  echo "        ^__^"
  echo "        (oo)\\_______"
  echo "        (__)\\       )\\/\\"
  echo "            ||----w |"
  echo "            ||     ||"
  echo
  echo "\033[31m Hold onto your butts...\033[0m"
  echo
  echo
  echo -e " \033[32mdotFiles\033[0m - installation and configuration made easy."
  echo
  echo "This will install for both Ubuntu and macOS instances. macOS virtual "
  echo "machine environts will skip macApp store installation. Profiles may"
  echo "be setup in the profiles directory."
  echo
  echo "Caveat Emptor"
  echo "        -- Mr. Brady."
  echo
  echo

}

# New function to handle the "init" command
init_dotfiles() {
  echo "Initialization complete. dotFile variables in environment file are:"
  echo "---------------------------------------------------"
  if [[ -f "${DOT_FILES_ENV_FILE_LOCATION}" ]]; then
    cat "${DOT_FILES_ENV_FILE_LOCATION}"
  else
    echo "Environment file not found at ${DOT_FILES_ENV_FILE_LOCATION}."
  fi
  echo "---------------------------------------------------"
}

# Parse additional arguments
parse_arguments() {
  while [[ $# -gt 0 ]]; do
    case $1 in
    --repo)
      SELECTED_REPO=$2
      shift # Consume argument value
      ;;
    *) ;;
    esac
    shift
  done
}

switch_to_zsh() {
  local current_shell zsh_path

  # Determine the current shell
  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS: get current shell
    current_shell=$(dscl . -read /Users/"$USER" UserShell | awk '{print $2}')
  else
    # Linux: get current shell
    if command -v getent >/dev/null 2>&1; then
      current_shell=$(getent passwd "$USER" | cut -d: -f7)
    else
      current_shell=$(grep "^$USER:" /etc/passwd | cut -d: -f7)
    fi
  fi

  # Determine the path to zsh
  zsh_path=$(command -v zsh)

  # Check if zsh is already the current shell
  if [[ "$current_shell" == "$zsh_path" ]]; then
    echo "zsh is already the default shell."
    echo "Switching to zsh for the current session..."
    exec "$zsh_path"
    return 0
  fi

  # Change the default shell only on Linux
  if [[ "$OSTYPE" != "darwin"* ]]; then
    echo "Changing default shell to zsh..."
    chsh -s "$zsh_path"
    if [[ $? -ne 0 ]]; then
      echo "Failed to change the default shell. Please check your permissions."
      return 1
    fi
    echo "Default shell successfully changed to zsh."
  fi

  # Switch to zsh in the current session
  echo "Switching to zsh for the current session..."
  exec "$zsh_path"
}

# Function to install Homebrew on macOS
install_homebrew() {
  if [[ "$(uname)" == "Darwin" ]]; then
    if ! command -v brew &>/dev/null; then
      echo "Installing Homebrew..."
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      if ! grep -q "eval \"\$(/opt/homebrew/bin/brew shellenv)\"" "${HOME}/.zshrc"; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >>"${HOME}/.zshrc"
      fi

      eval "$(/opt/homebrew/bin/brew shellenv)"
      echo "Homebrew installation complete."
    else
      echo "Homebrew is already installed."
    fi
  else
    echo "Skipping Homebrew installation: not on macOS."
  fi
}

# Function to install ZSH
install_zsh() {
  if command -v zsh &>/dev/null; then
    touch "${HOME}/.zshrc"
    echo "ZSH is already installed."
  else
    echo "Installing ZSH..."
    sudo apt update -q && sudo apt install -y zsh
    touch "${HOME}/.zshrc"
    echo "ZSH installation complete."
  fi
}

# Function to set up dotFiles
install_dotfiles() {
  echo "Setting up .dotFiles..."
  install_homebrew
  install_zsh

  # Branch or tag to use (default: main)
  local branch_or_tag="${BRANCH:-main}"

  echo "Cloning dotFiles from ${SELECTED_REPO}..."
  if git clone "${SELECTED_REPO}" "${TARGET}"; then
    cd "${TARGET}" || exit 1
    # Checkout branch or tag
    if git rev-parse --verify "refs/tags/${branch_or_tag}" >/dev/null 2>&1; then
      echo "Checking out tag ${branch_or_tag}..."
      git checkout "tags/${branch_or_tag}" -b "${branch_or_tag}-branch"
    else
      echo "Checking out branch ${branch_or_tag}..."
      git checkout "${branch_or_tag}"
    fi
    echo "dotFiles setup complete."
    switch_to_zsh
  else
    echo "Git clone failed. Exiting."
    exit 1
  fi
}

# Function to refresh dotFiles
refresh_dotfiles() {
  echo "Refreshing .dotFiles..."
  local branch_or_tag="${1:-main}"

  if [[ "${branch_or_tag}" == "--hard" ]]; then
    branch_or_tag="${2:-main}"
    echo "Performing a hard reset to ${branch_or_tag}..."
    rm -rf "${TARGET}"
    git clone "${SELECTED_REPO}" "${TARGET}" || {
      echo "Failed to clone repository. Exiting."
      exit 1
    }
    cd "${TARGET}" || exit 1
    if git rev-parse --verify "refs/tags/${branch_or_tag}" >/dev/null 2>&1; then
      echo "Checking out tag ${branch_or_tag}..."
      git checkout "tags/${branch_or_tag}" -b "${branch_or_tag}-branch"
    else
      echo "Checking out branch ${branch_or_tag}..."
      git checkout "${branch_or_tag}"
    fi
  else
    cd "${TARGET}" || exit 1
    if git rev-parse --verify "refs/tags/${branch_or_tag}" >/dev/null 2>&1; then
      echo "Fetching and checking out tag ${branch_or_tag}..."
      git fetch --tags
      git checkout "tags/${branch_or_tag}" -b "${branch_or_tag}-branch"
    else
      echo "Pulling latest updates from branch ${branch_or_tag}..."
      git pull origin "${branch_or_tag}" || {
        echo "Failed to pull updates. Exiting."
        exit 1
      }
    fi
  fi
}

# Main script logic
parse_arguments "$@"
case ${COMMAND} in
"" | "-h" | "--help")
  show_help
  ;;
init)
  init_dotfiles
  ;;
install)
  # Ensure the bootstrap script exists and is executable
  if [[ -x "${HOME}/.bootstrap/GitHarness.sh" ]]; then
    "${HOME}/.bootstrap/GitHarness.sh"
  fi
  install_dotfiles
  introduction
  ;;
refresh)
  refresh_dotfiles "$2"
  ;;
*)
  echo "Unknown command: ${COMMAND}" >&2
  show_help
  exit 1
  ;;
esac
