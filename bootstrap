#!/usr/bin/env bash

BIN_NAME=$(basename "$0")
COMMAND=$1 # Command entered - install or refresh
BRANCH=$2  # The branch name or commit reference can be passed as the second argument
PROJECT="dotFiles"
REPO="marana@git.kuzcotopia.io:marana/${PROJECT}.git"
TARGET="${HOME}/.dotFiles"

# Function to show help information
show_help() {
  echo "Usage: ${BIN_NAME} <command> [branch]"
  echo
  echo "Commands:"
  echo "   install                    Set up .dotFiles from scratch"
  echo "   install [branch]           Specify a branch to install or refresh (default: main)"
  echo "   refresh [--hard]           Refresh .dotFiles: use git pull or a hard reset (if --hard is provided)"
  echo
  echo "Options:"
  echo "   branch                      Specify a branch to install or refresh (default: main)"
  echo
  echo "Refreshing to a specific branch:"
  echo "If you want to refresh (pull the latest changes) from a specific branch, you can pass the branch name as the first argument after refresh. The script will use this branch for the pull operation."
  echo "./script_name refresh <branch_name>"
  echo
  echo "Hard reset to a specific branch:"
  echo "If you want to perform a hard reset to a specific branch (which deletes the current .dotFiles directory and reclones the specified branch), you can pass --hard followed by the branch name."
  echo "./script_name refresh --hard <branch_name>"
}

# Function to switch shell
switch_to_zsh() {
    local current_shell
    current_shell=$(getent passwd "$USER" | cut -d: -f7)
    local zsh_path
    zsh_path=$(command -v zsh)

    if [[ "${current_shell}" != "${zsh_path}" ]]; then
        echo "Changing default shell to ZSH..."
        if chsh -s "${zsh_path}"; then
            echo "Default shell changed to ZSH."
            echo "Please log out and back in for the change to take effect."
            echo "Or run 'zsh' manually to switch to ZSH for this session."

            # Optionally offer to switch for current session
            read -r -p "Would you like to switch to ZSH for this session? [y/N] " response
            if [[ "${response}" =~ ^[Yy]$ ]]; then
                exec "${zsh_path}" -l
            fi
        else
            echo "Failed to change default shell. You can manually run: chsh -s $(command -v zsh)"
        fi
    else
        echo "ZSH is already your default shell."
    fi
}

# Function to install Homebrew on macOS
install_homebrew() {
  if [[ "$(uname)" == "Darwin" ]]; then
    if ! command -v brew &>/dev/null; then
      echo "Installing Homebrew..."
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      echo "Adding Homebrew environment variables to Bash and ZSH..."
      if ! grep -q "eval \"\$(/opt/homebrew/bin/brew shellenv)\"" "${HOME}/.bashrc"; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> "${HOME}/.bashrc"
      fi

      if ! grep -q "eval \"\$(/opt/homebrew/bin/brew shellenv)\"" "${HOME}/.zshrc"; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> "${HOME}/.zshrc"
      fi

      eval "$(/opt/homebrew/bin/brew shellenv)"
      echo "Homebrew installation complete and environment variables set."
    else
      echo "Homebrew is already installed."
    fi
  else
    echo "Skipping Homebrew installation: not on macOS."
  fi
}

# Function to install ZSH
install_zsh() {
  if command -v zsh &>/dev/null; then
    touch "${HOME}/.zshrc"
    echo "ZSH is already installed."
  else
    echo "Installing ZSH..."
    if [[ "$(uname)" == "Darwin" ]]; then
      brew install zsh
    else
      sudo apt update -q
      sudo apt install -y zsh
    fi
    touch "${HOME}/.zshrc"
    echo "ZSH installation complete."
  fi
}

# Function to set up dotFiles with retry logic for git clone
install_dotfiles() {
  echo "Setting up .dotFiles..."
  install_homebrew
  install_zsh

  # Ensure the bootstrap script exists and is executable
  if [[ -x "${HOME}/.bootstrap/GitHarness.sh" ]]; then
    "${HOME}/.bootstrap/GitHarness.sh"
  else
    echo "Bootstrap script not found or not executable. Exiting."
    exit 1
  fi

  echo "Cloning dotFiles..."

  # Use default branch or provided branch
  BRANCH=${BRANCH:-"master"}

  # Retry logic for git clone
  local attempts=0
  local max_attempts=3
  while (( attempts < max_attempts )); do
    if git clone --branch "${BRANCH}" "${REPO}" "${TARGET}"; then
      echo "DotFiles setup complete."
      cd "${TARGET}"
      switch_to_zsh
    else
      attempts=$((attempts + 1))
      echo "Git clone failed. Attempt ${attempts} of ${max_attempts}."
      if (( attempts < max_attempts )); then
        echo "Please fix the access issue and press Enter to try again, or Ctrl+C to exit."
        read -r
      else
        echo "Maximum attempts reached. Exiting script."
        exit 1
      fi
    fi
  done
}
# Function to refresh dotFiles (normal or hard reset)
refresh_dotfiles() {
  echo "Refreshing .dotFiles..."
  local branch="${1:-main}"

  if [[ "${branch}" == "--hard" ]]; then
    branch="${2:-main}"
    echo "Performing a hard reset to branch ${branch}..."
    rm -rf "${TARGET}"
    if ! git clone --branch "${branch}" "${REPO}" "${TARGET}"; then
      echo "Failed to clone the repository. Exiting."
      exit 1
    fi
  else
    echo "Pulling the latest updates from branch ${branch}..."
    if [[ ! -d "${TARGET}" ]]; then
      echo "Target directory does not exist. Exiting."
      exit 1
    fi
    cd "${TARGET}" || exit 1
    if ! git pull origin "${branch}"; then
      echo "Failed to pull updates. Exiting."
      exit 1
    fi
  fi
}
# Command handler
case ${COMMAND} in
  "" | "-h" | "--help")
	show_help
	;;
  install)
	install_dotfiles
	;;
  refresh)
	refresh_dotfiles "$2"
	;;
  *)
	echo "Unknown command: ${COMMAND}" >&2
	show_help
	exit 1
	;;
esac