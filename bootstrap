#!/usr/bin/env bash

BIN_NAME=$(basename "$0")
COMMAND=$1 # Command entered - install or refresh
BRANCH=$2  # The branch name or commit reference can be passed as the second argument
PROJECT="dotFiles"
REPO="marana@git.kuzcotopia.io:marana/${PROJECT}.git"
TARGET="${HOME}/.dotFiles"

# Function to show help information
show_help() {
  echo "Usage: ${BIN_NAME} <command> [branch]"
  echo
  echo "Commands:"
  echo "   install                    Set up .dotFiles from scratch"
  echo "   install [branch]           Specify a branch to install or refresh (default: main)"
  echo "   refresh [--hard]           Refresh .dotFiles: use git pull or a hard reset (if --hard is provided)"
  echo
  echo "Options:"
  echo "   branch                      Specify a branch to install or refresh (default: main)"
  echo
  echo "Refreshing to a specific branch:"
  echo "If you want to refresh (pull the latest changes) from a specific branch, you can pass the branch name as the first argument after refresh. The script will use this branch for the pull operation."
  echo "./script_name refresh <branch_name>"
  echo
  echo "Hard reset to a specific branch:"
  echo "If you want to perform a hard reset to a specific branch (which deletes the current .dotFiles directory and reclones the specified branch), you can pass --hard followed by the branch name."
  echo "./script_name refresh --hard <branch_name>"
}

# Function to install Homebrew on macOS
install_homebrew() {
  if [[ "$(uname)" == "Darwin" ]]; then
    if ! command -v brew &>/dev/null; then
      echo "Installing Homebrew..."
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      echo "Adding Homebrew environment variables to Bash and ZSH..."
      if ! grep -q "eval \"\$(/opt/homebrew/bin/brew shellenv)\"" "${HOME}/.bashrc"; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> "${HOME}/.bashrc"
      fi

      if ! grep -q "eval \"\$(/opt/homebrew/bin/brew shellenv)\"" "${HOME}/.zshrc"; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> "${HOME}/.zshrc"
      fi

      eval "$(/opt/homebrew/bin/brew shellenv)"
      echo "Homebrew installation complete and environment variables set."
    else
      echo "Homebrew is already installed."
    fi
  else
    echo "Skipping Homebrew installation: not on macOS."
  fi
}

# Function to install ZSH
install_zsh() {
  if command -v zsh &>/dev/null; then
    touch "${HOME}/.zshrc"
    echo "ZSH is already installed."
  else
    echo "Installing ZSH..."
    if [[ "$(uname)" == "Darwin" ]]; then
      brew install zsh
    else
      sudo apt update -q
      sudo apt install -y zsh
    fi
    touch "${HOME}/.zshrc"
    echo "ZSH installation complete."
  fi
}

# Function to set up dotFiles
install_dotfiles() {
  echo "Setting up .dotFiles..."
  install_homebrew
  install_zsh
  "${HOME}/.bootstrap/GitHarness.sh"
  echo "Cloning dotFiles..."

  # Use default branch or provided branch
  BRANCH=${BRANCH:-"main"}

  git clone --branch "${BRANCH}" "${REPO}" "${TARGET}"

  echo "DotFiles setup complete. Switching to ZSH..."
  exec zsh
}

# Function to refresh dotFiles (normal or hard reset)
refresh_dotfiles() {
  echo "Refreshing .dotFiles..."

  BRANCH=${BRANCH:-"main"}

  if [[ "$1" == "--hard" ]]; then
	echo "Performing a hard reset..."
	rm -rf "${TARGET}"
	git clone --branch "${BRANCH}" "${REPO}" "${TARGET}"
  else
	echo "Pulling the latest updates..."
	cd "${TARGET}" || exit 1
	git pull origin "${BRANCH}"
  fi

  cd "${TARGET}" || exit 1
}

# Command handler
case ${COMMAND} in
  "" | "-h" | "--help")
	show_help
	;;
  install)
	install_dotfiles
	;;
  refresh)
	refresh_dotfiles "$2"
	;;
  *)
	echo "Unknown command: ${COMMAND}" >&2
	show_help
	exit 1
	;;
esac