#!/usr/bin/env bash

##
##  dotFiles bootstrap script (cleaned & platform unified)
##

# Determine the original user's home directory when using sudo
if [[ -n "$SUDO_USER" ]]; then
  ORIGINAL_USER_HOME=$(eval echo "~$SUDO_USER")
else
  ORIGINAL_USER_HOME="${HOME}"
fi

#######################################################
##               Project Settings                   ##
#######################################################
DF_PROJECT_NAME="dotFiles"
REPO1="git@git.thesecretlab.io:marana/dotFiles.git"
REPO1_NAME="Kuzcotopia"
REPO2="git@github.com:heymarkarana/dotFiles.git"
REPO2_NAME="GitHub"

DF_INSTALL_FOLDER_NAME=".${DF_PROJECT_NAME}"

BIN_NAME=$(basename "$0")
COMMAND=$1
BRANCH=$2

DEFAULT_REPO="${REPO1}"
SELECTED_REPO="${DEFAULT_REPO}"
TARGET="${ORIGINAL_USER_HOME}/${DF_INSTALL_FOLDER_NAME}"

# Detect OS platform and return one of: macOS, ubuntu
detect_platform() {
  if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "macOS"
  elif [[ -f "/etc/lsb-release" ]] && grep -q "Ubuntu" "/etc/lsb-release"; then
    echo "ubuntu"
  else
    echo "Error: Unsupported platform. Only macOS and Ubuntu are supported." >&2
    exit 1
  fi
}

# Get current working directory as bootstrap home
set_bootstrap_home() {
  [[ -z "$DF_BOOTSTRAP_HOME" ]] && DF_BOOTSTRAP_HOME="$(pwd)"
  echo "${DF_BOOTSTRAP_HOME}"
}

DF_PLATFORM=$(detect_platform)
DF_BOOTSTRAP_HOME=$(set_bootstrap_home)

show_help() {
  echo
  echo "Usage: ${BIN_NAME} <command> [branch|tag] [options]"
  echo
  echo "Commands:"
  echo "   install                     Set up .dotFiles from scratch. Installs ZSH and Homebrew if required."
  echo "   install [branch|tag]        Specify a branch or tag to install. Defaults to 'main'."
  echo "   refresh                     Refresh the existing .dotFiles repository."
  echo "   refresh <branch|tag>        Refresh and pull a specific branch or tag."
  echo "   refresh --hard <branch|tag> Hard reset to a specific branch or tag. Deletes and reclones the repo."
  echo
  echo "Options:"
  echo "   --repo <repository>        Specify the repository to clone from."
  echo
}

parse_arguments() {
  while [[ $# -gt 0 ]]; do
    case $1 in
      --repo)
        SELECTED_REPO=$2
        shift
        ;;
    esac
    shift
  done
}

switch_to_zsh() {
  local current_shell zsh_path

  if [[ "$DF_PLATFORM" == "macOS" ]]; then
    current_shell=$(dscl . -read /Users/"$USER" UserShell | awk '{print $2}')
  else
    if command -v getent >/dev/null 2>&1; then
      current_shell=$(getent passwd "$USER" | cut -d: -f7)
    else
      current_shell=$(grep "^$USER:" /etc/passwd | cut -d: -f7)
    fi
  fi

  zsh_path=$(command -v zsh)

  if [[ "$current_shell" == "$zsh_path" ]]; then
    echo "zsh is already the default shell. Switching for current session..."
    exec "$zsh_path"
    return 0
  fi

  if [[ "$DF_PLATFORM" == "ubuntu" ]]; then
    echo "Changing default shell to zsh..."
    chsh -s "$zsh_path"
  fi

  echo "Switching to zsh for current session..."
  exec "$zsh_path"
}

install_homebrew() {
  if [[ "$DF_PLATFORM" == "macOS" ]] && ! command -v brew &>/dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> "${ORIGINAL_USER_HOME}/.zshrc"
    eval "$(/opt/homebrew/bin/brew shellenv)"
    echo "Homebrew installation complete."
  else
    echo "Homebrew already installed or not on macOS."
  fi
}

install_zsh() {
  if ! command -v zsh &>/dev/null; then
    echo "Installing ZSH..."
    if [[ "$DF_PLATFORM" == "ubuntu" ]]; then
      sudo apt update -q && sudo apt install -y zsh
    fi
  fi
  touch "${ORIGINAL_USER_HOME}/.zshrc"
  echo "ZSH ready."
}

verify_git_access() {
  local host
  host=$(echo "$SELECTED_REPO" | sed -n 's#.*@\([^:]*\):.*#\1#p')

  if [[ -z "$host" ]]; then
    echo "Could not parse SSH host from repository: $SELECTED_REPO"
    return 1
  fi

  echo "Verifying SSH access to ${host}..."
  if ssh -o BatchMode=yes -T "git@${host}" 2>&1 | grep -qi "successfully authenticated"; then
    echo "✅ SSH access to ${host} verified."
  else
    echo "❌ SSH access to ${host} failed."
    echo "Make sure your SSH key is added to ${host} (e.g., GitHub or Forgejo)."
    echo "You can manually test with: ssh -T git@${host}"
    exit 1
  fi
}

install_dotfiles() {
  echo "Setting up .dotFiles..."
  install_homebrew
  install_zsh
  verify_git_access

  local branch_or_tag="${BRANCH:-main}"

  echo "Cloning from ${SELECTED_REPO}..."
  if git clone --depth 1 --branch "${branch_or_tag}" "${SELECTED_REPO}" "${TARGET}"; then
    cd "${TARGET}" || exit 1
    echo "dotFiles setup complete."
    switch_to_zsh
  else
    echo "Git clone failed. Exiting."
    exit 1
  fi
}

refresh_dotfiles() {
  echo "Refreshing .dotFiles..."
  local branch_or_tag="${1:-main}"

  if [[ "${branch_or_tag}" == "--hard" ]]; then
    branch_or_tag="${2:-main}"
    echo "Hard reset to ${branch_or_tag}..."
    rm -rf "${TARGET}"
    if git clone --depth 1 --branch "${branch_or_tag}" "${SELECTED_REPO}" "${TARGET}"; then
      cd "${TARGET}" || exit 1
    else
      echo "Clone failed. Exiting."
      exit 1
    fi
  else
    cd "${TARGET}" || exit 1
    if git rev-parse --verify "refs/tags/${branch_or_tag}" >/dev/null 2>&1; then
      echo "Checking out tag ${branch_or_tag}..."
      git fetch --tags
      git checkout "tags/${branch_or_tag}" -b "${branch_or_tag}-branch"
    else
      echo "Pulling updates from branch ${branch_or_tag}..."
      git pull origin "${branch_or_tag}" || exit 1
    fi
  fi
}

# Main logic
parse_arguments "$@"
case ${COMMAND} in
  "" | "-h" | "--help")
    show_help
    ;;
  init)
    echo "Environment file is now managed separately. No action performed."
    ;;
  install)
    if [[ -x "${ORIGINAL_USER_HOME}/.bootstrap/GitHarness.sh" ]]; then
      "${ORIGINAL_USER_HOME}/.bootstrap/GitHarness.sh"
    fi
    install_dotfiles
    ;;
  refresh)
    refresh_dotfiles "$2"
    ;;
  *)
    echo "Unknown command: ${COMMAND}" >&2
    show_help
    exit 1
    ;;
esac